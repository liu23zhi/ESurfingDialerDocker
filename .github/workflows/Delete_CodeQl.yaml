name: 删除CodeQL的所有记录
on:
  workflow_dispatch: # 手动触发

jobs:
  del_codeql_runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: 列出 CodeQL 工作流程运行
        id: list_runs
        uses: actions/github-script@v6
        with:
          script: |
            // 列出所有 CodeQL 工作流程运行ID
            const runs = await github.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'CodeQL'
            });
            return runs.data.workflow_runs.map(run => run.id);
      - name: 删除 CodeQL 工作流程运行
        if: ${{ steps.list_runs.outputs.length > 0 }}
        run: |
          // 删除列出的 CodeQL 工作流程运行
          for run_id in ${{ steps.list_runs.outputs }}; do
            curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id
          done
