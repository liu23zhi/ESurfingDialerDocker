name: 删除GitHub Action中CodeQL的所有记录
on:
  workflow_dispatch: # 手动触发

jobs:
  Delete_CodeQL_workflow_runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: 获取 CodeQL 工作流程运行
        id: get_runs
        run: |
          runs=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=completed&per_page=100" | jq -r '.workflow_runs[] | select(.name=="CodeQL") | .id')
          echo "::set-output name=run_ids::$runs"
      - name: 删除 CodeQL 工作流程运行
        run: |
          for run_id in ${{ steps.get_runs.outputs.run_ids }}; do
            echo "Deleting run $run_id"
            curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
          done
